name: Frontend CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'

jobs:
  check:
    name: Type Check & Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '9'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Type Check
        run: pnpm tsc --noEmit

      - name: Lint
        run: pnpm lint

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: check
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || (github.event_name == 'pull_request' && github.base_ref == 'main')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '9'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Package Standalone Build
        run: |
          echo "=== Packaging Standalone Build ==="
          
          # standalone 디렉토리 확인
          if [ ! -d ".next/standalone" ]; then
            echo " Error: .next/standalone not found!"
            echo "next.config.ts에 output: 'standalone' 설정이 필요합니다."
            exit 1
          fi
          
          # static 파일 복사 (standalone에는 포함 안됨)
          cp -r .next/static .next/standalone/.next/
          
          # public 폴더 복사
          if [ -d "public" ]; then
            cp -r public .next/standalone/
          fi
          
          # ============================================
          # 누락될 수 있는 필수 의존성 복사
          # Standalone이 일부 패키지를 누락하는 이슈 대응
          # ============================================
          DEPS_TO_COPY="styled-jsx sharp"
          for dep in $DEPS_TO_COPY; do
            if [ -d "node_modules/$dep" ]; then
              echo " Copying missing dependency: $dep"
              cp -r node_modules/$dep .next/standalone/node_modules/
            fi
          done
          
          echo ""
          echo "=== Build Output Size ==="
          du -sh .next/standalone/
          echo ""
          echo "=== Standalone Structure ==="
          ls -la .next/standalone/
          ls -la .next/standalone/node_modules/ | head -20

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: .next/standalone/
          retention-days: 1
          if-no-files-found: error
          include-hidden-files: true

  notify-failure:
    name: Discord Notification
    runs-on: ubuntu-latest
    needs: [check, build]
    if: always() && (needs.check.result == 'failure' || needs.build.result == 'failure')
    
    steps:
      - name: Send Discord Notification
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: failure
          title: "Frontend CI 빌드 실패"
          description: |
            **Repository:** ${{ github.repository }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Author:** ${{ github.actor }}
            **Check Job:** ${{ needs.check.result }}
            **Build Job:** ${{ needs.build.result }}
          color: 0xff0000
