name: Frontend Dev CD

on:
  workflow_run:
    workflows: ["Frontend CI"]
    types: [completed]
    branches: [develop]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Download CI Artifacts
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ${{ github.event.workflow_run.workflow_id }}
          run_id: ${{ github.event.workflow_run.id }}
          name: frontend-build
          path: ./frontend-build

      # [추가된 단계] 여기가 핵심입니다!
      # SCP 전송 전에 서버의 폴더를 깨끗하게 초기화합니다.
      - name: Reset Deploy Directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.DEV_EC2_SSH_KEY }}
          script: |
            # 1. 기존 폴더가 root 권한일 수 있으니 sudo로 강제 삭제
            sudo rm -rf /home/ubuntu/deploy_temp
            
            # 2. ubuntu(현재 사용자) 권한으로 폴더 새로 생성
            mkdir -p /home/ubuntu/deploy_temp

      # 이제 폴더가 확실히 존재하고 권한도 있으므로 실패하지 않습니다.
      - name: Upload to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEV_EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.DEV_EC2_SSH_KEY }}
          source: "frontend-build/**/*"
          target: "/home/ubuntu/deploy_temp"
          strip_components: 1

      - name: Deploy & Restart
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.DEV_EC2_SSH_KEY }}
          script: |
            # 1. 실제 서비스 경로 준비
            sudo mkdir -p /opt/billage/frontend
            sudo chown ubuntu:ubuntu /opt/billage/frontend
            
            # 2. 기존 파일 삭제
            rm -rf /opt/billage/frontend/*
            
            # 3. 파일 이동 (숨김 파일 포함)
            cp -r /home/ubuntu/deploy_temp/. /opt/billage/frontend/
            
            # 4. 임시 폴더 삭제
            rm -rf /home/ubuntu/deploy_temp
            
            # 5. 서비스 재시작
            sudo systemctl restart billage-frontend
            
            # 6. 상태 확인
            sleep 2
            systemctl status billage-frontend --no-pager
