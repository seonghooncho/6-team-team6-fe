name: Frontend Dev CD

on:
  workflow_run:
    workflows: ["Frontend CI"]
    types: [completed]
    branches: [develop]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Download CI Artifacts
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ${{ github.event.workflow_run.workflow_id }}
          run_id: ${{ github.event.workflow_run.id }}
          name: frontend-build
          path: ./frontend-build

      # 1. 여기서 그냥 압축해버림 (파일 1개로 만드는 게 전송 제일 빠르고 속 편함)
      - name: Compress Files
        run: tar -czf build.tar.gz -C ./frontend-build .

      # 2. 서버의 홈 디렉토리(/home/ubuntu)로 그냥 던짐
      # (홈 디렉토리는 무조건 존재하니까 에러 안 남)
      - name: Upload to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEV_EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.DEV_EC2_SSH_KEY }}
          source: "build.tar.gz"
          target: "/home/ubuntu/"

      # 3. 접속해서 제자리에 압축 풀고 재시작 (끝)
      - name: Deploy & Restart
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.DEV_EC2_SSH_KEY }}
          script: |
            # 목표 폴더 없으면 생성 (sudo 권한)
            sudo mkdir -p /opt/billage/frontend
            sudo chown ubuntu:ubuntu /opt/billage/frontend
            
            # 기존 파일 싹 지우기 (깨끗하게)
            rm -rf /opt/billage/frontend/*
            
            # 아까 던져놓은 파일 압축 풀어서 목표 폴더에 넣기
            tar -xzf /home/ubuntu/build.tar.gz -C /opt/billage/frontend/
            
            # 다 썼으니 압축파일 삭제
            rm /home/ubuntu/build.tar.gz
            
            # 재시작
            sudo systemctl restart billage-frontend
